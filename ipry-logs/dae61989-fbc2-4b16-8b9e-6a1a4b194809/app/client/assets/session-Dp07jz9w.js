import{u as n,g as C,c as r,L as O,p as g,A as w,a as h,i as k,s as p,d as I,b as y,e as f,E as D,w as m}from"./index-BnTlsbFl.js";import{i as K}from"./insomnia-fetch-B_XbrnGh.js";async function J(t,a){const{publicKey:i,encPrivateKey:s,encSymmetricKey:e,email:o,accountId:l,firstName:d,lastName:c}=await A(t),u=I(a,JSON.parse(e));await N(t,l,d,c,o,JSON.parse(u),JSON.parse(i),JSON.parse(s)),window.main.loginStateChange()}async function R(){const t=await v();if(!t)throw new Error("Can't get private key: session is blank.");const{symmetricKey:a,encPrivateKey:i}=t;if(!a||!i)throw new Error("Can't get private key: session is missing keys.");const s=I(a,i);return JSON.parse(s)}async function _(){const{id:t}=await n.getOrCreate();return t}async function T(){return(await v())?.accountId}async function F(t=!1){const a=await _();if(a)try{K({method:"POST",path:"/auth/logout",sessionId:a})}catch(i){console.warn("Failed to logout",i)}await P(),t&&await E(),window.main.loginStateChange()}async function N(t,a,i,s,e,o,l,d){const c={id:t,accountId:a,symmetricKey:o,publicKey:l,encPrivateKey:d,email:e,firstName:i,lastName:s},u=await n.getOrCreate();return await n.update(u,c),c}async function M(t,a){const i=await n.getOrCreate();await n.update(i,{vaultSalt:t,vaultKey:a})}async function A(t=null){const a=await K({method:"GET",path:"/auth/whoami",sessionId:t||await _()});if(typeof a=="string")throw new Error("Unexpected plaintext response: "+a);if(a&&!a?.encSymmetricKey)throw new Error("Unexpected response: "+JSON.stringify(a));return a}async function v(){return await n.getOrCreate()}async function P(){await n.getOrCreate(),await n.update(await n.getOrCreate(),{id:"",accountId:"",email:"",firstName:"",lastName:"",symmetricKey:{},publicKey:{},encPrivateKey:{},vaultSalt:"",vaultKey:""})}async function E(){const t=[C.removeAll()],a=await r.all();for(const e of a)if("credentials"in e){if("secretAccessKey"in e.credentials){t.push(r.update(e,{credentials:{...e.credentials,secretAccessKey:"",sessionToken:""}}));continue}if("access_token"in e.credentials){t.push(r.update(e,{credentials:{...e.credentials,access_token:""}}));continue}if("client_secret"in e.credentials){t.push(r.update(e,{credentials:{...e.credentials,client_secret:""}}));continue}if("secret_id"in e.credentials){t.push(r.update(e,{credentials:{...e.credentials,secret_id:"",role_id:""}}));continue}"accessToken"in e.credentials&&t.push(r.update(e,{credentials:{...e.credentials,accessToken:""}}))}for(const e of O)await g.getByKey(w,`${e}.apiKey`)&&(t.push(g.removeByKey(w,`${e}.apiKey`)),e===await window.main.llm.getActiveBackend()&&t.push(window.main.llm.clearActiveBackend()));const i=await h.all();for(const e of i)e.credentials&&(k(e.credentials)?e.credentials.token&&t.push(S(e)):e.credentials.password&&t.push(S(e)));const s=await p.get();s.httpProxy?.includes("@")&&t.push(p.update(s,{httpProxy:""})),s.httpsProxy?.includes("@")&&t.push(p.update(s,{httpsProxy:""})),await Promise.all(t)}async function S(t){const a=await y.find(f.type,{gitRepositoryId:t._id});for(const s of a)await f.update(s,{gitRepositoryId:D});const i=await y.find(m.type,{gitRepositoryId:t._id});for(const s of i)await m.update(s,{gitRepositoryId:null});await h.remove(t)}async function G(){if(!window.localStorage.getItem("file-origin-localStorage-migrated")){console.log("[migration] Migrating localStorage data from file origin");try{const s=await window.main.getLocalStorageDataFromFileOrigin();if(s){for(const[e,o]of Object.entries(s))e&&o&&localStorage.setItem(e,o);localStorage.setItem("file-origin-localStorage-migrated","true")}}catch(s){console.error("[migration] Failed to migrate localStorage data:",s)}}const t=window.localStorage.getItem("currentSessionId");if(!t)return;const a=`session__${(t||"").slice(0,10)}`,i=window.localStorage.getItem(a);if(i)try{const s=JSON.parse(i),e=await n.getOrCreate();e.id?console.warn("Session already exists, skipping migration"):await n.update(e,s)}catch(s){console.error("Failed to parse session data",s)}finally{window.localStorage.removeItem(a),window.localStorage.removeItem("currentSessionId")}}export{J as a,M as b,R as c,_ as d,T as e,v as g,F as l,G as m,N as s};
//# sourceMappingURL=session-Dp07jz9w.js.map
