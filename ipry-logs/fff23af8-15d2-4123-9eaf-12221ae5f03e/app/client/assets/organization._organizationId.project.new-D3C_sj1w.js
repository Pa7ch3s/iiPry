import{h as y}from"./chunk-WY5IRSCW-1dc6FieG.js";import{r as w}from"./chunk-OIYGIGL5-BYynBxW5.js";import{u as T,e as u,E,b as I,F as R}from"./index-BnTlsbFl.js";import{S as k}from"./analytics-fpOjxorv.js";import{i as l}from"./insomnia-fetch-B_XbrnGh.js";import{i as f}from"./invariant-DVddvGrP.js";import{c as j}from"./router-BoVIwh1i.js";const O=()=>{let o=!1;const n=[],t=async()=>{if(!o){o=!0;return}return new Promise(e=>{n.push(e)})},c=async()=>{n.length>0?n.shift()?.():o=!1};return{wrapWithLock:e=>async(...p)=>{await t();try{return await e(...p)}finally{await c()}},lock:t,unlock:c}},S=O(),d=async(o,n,t=3)=>{const e=(await I.find(u.type,{parentId:o})).map(i=>i.gitRepositoryId).filter(R).length;for(let i=1;i<=t;i++)try{await l({method:"PATCH",path:`/v1/organizations/${o}/git-projects`,sessionId:n,onlyResolveOnSuccess:!0,data:{count:e}});return}catch{i<t&&await new Promise(s=>setTimeout(s,i*1e3))}console.warn("Report git project count failed")},v=async(o,n)=>{const t=async(r,e)=>{const p=(await T.getOrCreate()).id;if(f(p,"User must be logged in to create a project"),e.storageType==="local")return(await u.create({name:e.name,parentId:r}))._id;if(e.storageType==="git"){if(e.connectRepositoryLater){const g=await u.create({name:e.name,parentId:r,gitRepositoryId:E});return d(r,p),g._id}let a;e.oauth2format==="custom"?a={username:e.username||"",password:e.token||""}:e.oauth2format?a={oauth2format:e.oauth2format,token:e.token||"",username:e.username||""}:e.username&&e.password&&(a={username:e.username,password:e.password});const{projectId:h,errors:m}=await window.main.git.cloneGitRepo({organizationId:r,uri:e.uri||"",author:{name:e.authorName||"",email:e.authorEmail||""},name:e.name,credentials:a||{username:"",password:""}});if(m)throw new Error(m.join(", "));return d(r,p),h}const s=await l({path:`/v1/organizations/${r}/team-projects`,method:"POST",data:{name:e.name},sessionId:p});if(!s||"error"in s){let a="An unexpected error occurred while creating the project. Please try again.";throw s.error==="FORBIDDEN"&&(a="You do not have permission to create a cloud project in this organization."),s.error==="NEEDS_TO_UPGRADE"&&(a="Upgrade your account in order to create new Cloud Projects."),s.error==="PROJECT_STORAGE_RESTRICTION"&&(a=s.message??"The owner of the organization allows only Local Vault project creation."),new Error(a)}return(await u.create({_id:s.id,name:s.name,remoteId:s.id,parentId:r}))._id},c=await S.wrapWithLock(t)(o,n);return window.main.trackSegmentEvent({event:k.projectCreated,properties:{storage:n.storageType}}),c};async function b({request:o,params:n}){const{organizationId:t}=n;f(t,"Organization ID is required");const c=await o.json();try{const r=await v(t,c);return w(`/organization/${t}/project/${r}`)}catch(r){return console.log(r),{error:r instanceof Error?r.message:`An unexpected error occurred while creating the project. Please try again. ${r}`}}}const x=j(o=>({organizationId:n,projectData:t})=>o(JSON.stringify(t),{method:"POST",action:y("/organization/:organizationId/project/new",{organizationId:n}),encType:"application/json"}));export{b as a,v as c,S as p,d as r,x as u};
//# sourceMappingURL=organization._organizationId.project.new-D3C_sj1w.js.map
