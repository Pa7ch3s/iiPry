import{h as P}from"./chunk-WY5IRSCW-1dc6FieG.js";import{e as c,u as O,a as d,E as S,k as v,b as f,w as y}from"./index-BnTlsbFl.js";import{p as I,r as w}from"./organization._organizationId.project.new-D3C_sj1w.js";import{S as u}from"./analytics-fpOjxorv.js";import{i as l}from"./insomnia-fetch-B_XbrnGh.js";import{i as h}from"./invariant-DVddvGrP.js";import{c as C}from"./router-BoVIwh1i.js";async function G({request:m,params:g}){const{name:o,storageType:i,...a}=await m.json();h(typeof o=="string","Name is required"),h(i==="local"||i==="remote"||i==="git","Project type is required");const{organizationId:s,projectId:j}=g,r=await c.getById(j);h(r,"Project not found");const n=(await O.getOrCreate()).id;try{if(await I.lock(),n&&r.remoteId&&i==="remote"&&o!==r.name){const e=await l({path:`/v1/organizations/${r.parentId}/team-projects/${r.remoteId}`,method:"PATCH",sessionId:n,data:{name:o}});if(e&&"error"in e){let t="An unexpected error occurred while updating your project. Please try again.";return e.error==="FORBIDDEN"&&(t="You do not have permission to create a cloud project in this organization."),e.error==="NEEDS_TO_UPGRADE"&&(t="Upgrade your account in order to create new Cloud Projects."),e.error==="PROJECT_STORAGE_RESTRICTION"&&(t="The owner of the organization allows only Local Vault project creation, please try again."),{error:t}}return await c.update(r,{name:o}),{success:!0}}if(i==="local"&&r.remoteId){const e=await l({path:`/v1/organizations/${s}/team-projects/${r.remoteId}`,method:"DELETE",sessionId:n});if(e&&!e.error&&window.main.trackSegmentEvent({event:u.projectUpdated,properties:{storage:"local"}}),e&&"error"in e){let t="An unexpected error occurred while updating your project. Please try again.";return e.error==="FORBIDDEN"&&(t="You do not have permission to change this project."),e.error==="PROJECT_STORAGE_RESTRICTION"&&(t="The owner of the organization allows only Cloud Sync project creation, please try again."),{error:t}}return await c.update(r,{name:o,remoteId:null}),{success:!0}}if(i==="remote"&&!r.remoteId){const e=await l({path:`/v1/organizations/${s}/team-projects`,method:"POST",data:{name:o},sessionId:n});if(e&&!("error"in e)&&window.main.trackSegmentEvent({event:u.projectUpdated,properties:{storage:"remote"}}),!e||"error"in e){let t="An unexpected error occurred while updating your project. Please try again.";return e.error==="FORBIDDEN"&&(t=e.error),e.error==="NEEDS_TO_UPGRADE"&&(t="Upgrade your account in order to create new Cloud Projects."),e.error==="PROJECT_STORAGE_RESTRICTION"&&(t="The owner of the organization allows only Local Vault project creation, please try again."),{error:t}}if(r.gitRepositoryId){const t=await d.getById(r.gitRepositoryId);t&&await d.remove(t)}return await c.update(r,{name:o,remoteId:e.id,gitRepositoryId:null}),r.gitRepositoryId&&w(s,n),{success:!0}}if(i==="git"&&!r.gitRepositoryId){if(r.remoteId){const e=await l({path:`/v1/organizations/${s}/team-projects/${r.remoteId}`,method:"DELETE",sessionId:n});if(e&&!e.error&&window.main.trackSegmentEvent({event:u.projectUpdated,properties:{storage:"git"}}),e&&"error"in e){let t="An unexpected error occurred while updating your project. Please try again.";return e.error==="FORBIDDEN"&&(t="You do not have permission to change this project."),e.error==="PROJECT_STORAGE_RESTRICTION"&&(t="The owner of the organization allows only Cloud Sync project creation, please try again."),{error:t}}}if(a.connectRepositoryLater)await c.update(r,{name:o,gitRepositoryId:S});else{let e;a.oauth2format?e={oauth2format:a.oauth2format,token:a.token??"",username:a.username??""}:a.username&&a.password&&(e={username:a.username,password:a.password});const{errors:t}=await window.main.git.cloneGitRepo({organizationId:s,cloneIntoProjectId:r._id,author:{name:a.authorName??"",email:a.authorEmail??""},uri:a.uri??"",credentials:e||{username:"",password:""},ref:a.ref,name:o}),E=await v.findByParentId(r._id),R=await f.bufferChanges(),T=await f.find(y.type,{parentId:{$in:E.map(p=>p._id)}});for(const p of T)p.gitFilePath||await y.update(p,{gitFilePath:`insomnia.${p.parentId}.yaml`});if(await f.flushChanges(R),t)return{error:t.join(", ")}}return w(s,n),{success:!0}}if(i==="local"&&r.gitRepositoryId){const e=await d.getById(r.gitRepositoryId);return e&&await d.remove(e),await c.update(r,{name:o,gitRepositoryId:null}),w(s,n),{success:!0}}return await c.update(r,{name:o}),window.main.trackSegmentEvent({event:u.projectUpdated,properties:{storage:"local"}}),{success:!0}}catch(e){return console.log(e),{error:e instanceof Error?e.message:`An unexpected error occurred while renaming the project. Please try again. ${e}`}}finally{await I.unlock()}}const U=C(m=>({organizationId:g,projectId:o,projectData:i})=>m(JSON.stringify(i),{method:"POST",action:P("/organization/:organizationId/project/:projectId/update",{organizationId:g,projectId:o}),encType:"application/json"}));export{G as c,U as u};
//# sourceMappingURL=organization._organizationId.project._projectId.update-CnIPYBnW.js.map
